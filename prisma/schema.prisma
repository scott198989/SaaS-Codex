generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum RunStatus {
  QUEUED
  RUNNING
  PAUSED
  FAILED
  COMPLETE
}

enum ExportType {
  TEXT
  QNA_JOINED
  QNA_STRUCTURED
}

model User {
  id               String              @id @default(cuid())
  email            String              @unique
  name             String?
  passwordHash     String
  emailVerifiedAt  DateTime?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  sessions         Session[]
  verificationTokens VerificationToken[]
  resetTokens      PasswordResetToken[]
  memberships      Membership[]
  ownedWorkspaces  Workspace[]         @relation("WorkspaceOwner")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Workspace {
  id           String        @id @default(cuid())
  name         String
  slug         String        @unique
  ownerId      String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  owner        User          @relation("WorkspaceOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  memberships  Membership[]
  runs         Run[]
  exports      Export[]
  subscriptions Subscription[]
  usageRecords UsageRecord[]
  auditEvents  AuditEvent[]
}

model Membership {
  id          String    @id @default(cuid())
  userId      String
  workspaceId String
  role        String
  createdAt   DateTime  @default(now())
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([userId, workspaceId])
}

model Subscription {
  id                    String    @id @default(cuid())
  workspaceId           String
  stripeCustomerId      String?
  stripeSubscriptionId  String?
  stripePriceId         String?
  status                String
  currentPeriodStart    DateTime?
  currentPeriodEnd      DateTime?
  cancelAtPeriodEnd     Boolean   @default(false)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  workspace             Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
}

model UsageRecord {
  id            String   @id @default(cuid())
  workspaceId   String
  periodStart   DateTime
  periodEnd     DateTime
  pagesProcessed Int      @default(0)
  bytesProcessed Int      @default(0)
  runsStarted   Int      @default(0)
  updatedAt     DateTime @updatedAt
  workspace     Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, periodStart, periodEnd])
}

model Run {
  id             String     @id @default(cuid())
  workspaceId    String
  status         RunStatus  @default(QUEUED)
  label          String?
  sourceType     String
  totalFiles     Int        @default(0)
  totalPages     Int        @default(0)
  processedPages Int        @default(0)
  errors         Int        @default(0)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  startedAt      DateTime?
  completedAt    DateTime?
  workspace      Workspace  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  files          FileAsset[]
  logs           RunLog[]
  exports        Export[]
}

model FileAsset {
  id          String   @id @default(cuid())
  workspaceId String
  runId       String
  name        String
  storagePath String
  sizeBytes   Int?
  mimeType    String?
  createdAt   DateTime @default(now())
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  run         Run      @relation(fields: [runId], references: [id], onDelete: Cascade)
}

model Export {
  id          String      @id @default(cuid())
  workspaceId String
  runId       String?
  name        String
  type        ExportType
  storagePath String
  recordCount Int         @default(0)
  createdAt   DateTime    @default(now())
  workspace   Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  run         Run?        @relation(fields: [runId], references: [id], onDelete: SetNull)
}

model RunLog {
  id        String   @id @default(cuid())
  runId     String
  level     String
  stage     String
  message   String
  meta      Json?
  createdAt DateTime @default(now())
  run       Run      @relation(fields: [runId], references: [id], onDelete: Cascade)
}

model AuditEvent {
  id          String   @id @default(cuid())
  workspaceId String
  runId       String?
  eventType   String
  detail      Json?
  createdAt   DateTime @default(now())
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  run         Run?     @relation(fields: [runId], references: [id], onDelete: SetNull)
}
